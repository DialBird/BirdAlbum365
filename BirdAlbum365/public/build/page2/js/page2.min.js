"use strict";function SoundJukeBox(){this.birdNameList="",this.specificBirdSoundChannel="",this.BGMchannel="",this.isAvailable=!1,this.BGM_state="playing"}function OmniSphere(e){this.loader=BirdAlbumProject.loader,this.scene=e,this.geometry=""}function rayCastClosure(e,t,i,n,a){function o(e){if(g=!0,v!==!1){P=0,j.x=e.originalEvent.pageX/p*2-1,j.y=2*-(e.originalEvent.pageY/h)+1,b.setFromCamera(j,m);var t=b.intersectObjects(f);if(t.length>0){var i=t[0];w=i.object.parent.name,B={x:j.x,y:j.y},d.emit("tapStart",{id:c,parentObjectName:w})}}}function r(e){g=!1,B&&(j.x=e.originalEvent.pageX/p*2-1,P=.01*(B.x-j.x),d.emit("tapMove",{id:c,parentObjectName:w,speed:P}))}function s(e){if(function(){B="",d.emit("tapEnd",{id:c,parentObjectName:w,speed:P})}(),g){if(g=!1,v===!1)return;j.x=e.originalEvent.pageX/p*2-1,j.y=2*-(e.originalEvent.pageY/h)+1,b.setFromCamera(j,m);var t=b.intersectObjects(f);if(t.length>0){var i=t[0];"PC"===l?(d.emit("checkData",{id:c,name:i.object.name,birdName:i.object.birdName,pos:i.object.position}),d.emit("selectBird",{id:c,birdName:i.object.birdName})):"SM"===l&&d.emit("selectBird",{id:c,birdName:i.object.birdName})}}}var d=BirdAlbumProject.socket,c=BirdAlbumProject.this_roomID,l=BirdAlbumProject.thisDevice,m=e,u=t,p=i,h=n,f=a,v=!1,g=!1,b=new THREE.Raycaster,j=new THREE.Vector2,w="",B="",P=0;u.on({touchstart:o,touchmove:r,touchend:s}),this.changeRayCastSwitch=function(e){v=e}}function animationClosure(e,t){var i=BirdAlbumProject.thisDevice,n=(BirdAlbumProject.planePositions,e),a=n.length,o=t,r=o.length;if("PC"===i){$(".birdNavWindow"),$(".birdNavWindow__birdName"),$(".birdNavWindow__birdPicture")}var s,d="cylinder",c="off",l=.05,m=[!0,!0,!0,!0,!0];this.changeAnimationMode=function(e){c=e},this.changeRotateSwitch=function(e,t){m[e]=t},this.rotateSpecificParent=function(e,t){o[e].rotation.y+=t},this.observe=function(){switch(d){case"cylinder":this.controlCylinderAnimation()}},this.controlCylinderAnimation=function(){switch(c){case"start":break;case"normal":for(s=0;r>s;s++)m[s]!==!1&&(o[s].rotation.y+=l*Math.PI/180*Math.pow(-1,s));break;case"appear":this.rotateAppearAnimation(),c="off";break;case"disappear":this.rotateDisppearAnimation(),c="off";break;case"shaffle":this.shaffleAnimation(),c="normal";break;case"off":}},this.rotateAppearAnimation=function(){function e(){for(s=0;r>s;s++)o[s].rotation.y+=Math.pow(-1,s)*i.y}function t(){c="normal"}for(s=0;r>s;s++){var i={y:Math.PI/720};TweenLite.fromTo(i,1,{y:Math.PI/720},{y:0,onUpdate:e})}for(s=0;a>s;s++)n[s].material.depthWrite=!0,TweenLite.fromTo(n[s].material,1,{opacity:0},{opacity:1,onComplete:t})},this.rotateDisppearAnimation=function(){function e(){for(s=0;r>s;s++)o[s].rotation.y+=Math.pow(-1,s)*t.y}for(s=0;r>s;s++){var t={y:0};TweenLite.fromTo(t,1,{y:0},{y:Math.PI/720,onUpdate:e})}for(s=0;a>s;s++)n[s].material.depthWrite=!0,TweenLite.fromTo(n[s].material,1,{opacity:1},{opacity:0,onComplete:function(){c="off"}})},this.shaffleAnimation=function(){for(s=0;a>s;s++)TweenLite.fromTo(n[s].material,Math.random(),{opacity:0},{opacity:1,delay:2*Math.random()})}}function preloadData(){var e,t,i=BirdAlbumProject.thisDevice;!function(){if("PC"===i){var e=[{id:"audioSprite",src:"/json/birdSoundsSprite.json"},{id:"birdData",src:"/json/birdData.json"}],t=new createjs.LoadQueue(!1);t.installPlugin(createjs.Sound),t.loadManifest(e),t.addEventListener("fileload",function(e){if("audioSprite"===e.item.id){createjs.Sound.alternateExtensions=["mp3"];var t=e.result;createjs.Sound.registerSounds(t)}"birdData"===e.item.id&&(BirdAlbumProject.birdData=e.result)})}}(),t=[{id:"empty",src:"/img/dialbird.jpg"},{id:"planePositions",src:"/json/planePositions.json"},{id:"spriteImg",src:"/build/birdImages/birdSprite.min.jpg"},{id:"imageSprite",src:"/json/birdSprite.json"},{id:"springImg",src:"/img/springEnv/springEnv.min.jpg"},{id:"summerImg",src:"/img/summerEnv/summerEnv.min.jpg"},{id:"fallImg",src:"/img/fallEnv/fallEnv.min.jpg"},{id:"winterImg",src:"/img/winterEnv/winterEnv.min.jpg"}];var e=new createjs.LoadQueue(!1);e.addEventListener("fileload",handleFileload),"SM"===i?e.addEventListener("progress",handleProgress_for_SM):"PC"===i&&e.addEventListener("progress",handleProgress_for_PC),e.addEventListener("complete",init),e.loadManifest(t,!0),BirdAlbumProject.loader=e}function handleFileload(e){var t=e.item.type;switch(t){case"image":"empty"===e.item.id&&(BirdAlbumProject.emptyImg=e.result),"spriteImg"===e.item.id&&(BirdAlbumProject.spriteImage=e.result);break;case"json":"planePositions"===e.item.id&&(BirdAlbumProject.planePositions=e.result),"imageSprite"===e.item.id&&(BirdAlbumProject.spriteJSON=e.result)}}function handleProgress_for_SM(e){var t=$("#canvas"),i=$(".loadWindow"),n=$(".loadWindow__insideLoadBar"),a=$(".startWindow"),o=100*e.progress;n.css("width",o+"%"),100===o&&(i.addClass("js-hide"),t.addClass("js-show"),a.addClass("js-show"))}function handleProgress_for_PC(e){var t=100*e.progress;$(".loadingWindow__insideLoadBar").css("width",t+"%"),100===t&&($(".loadingWindow").addClass("js-disappear"),$(".QRCodeWindow").addClass("js-show"))}function init(){var e,t=BirdAlbumProject.socket,i=BirdAlbumProject.this_roomID,n=BirdAlbumProject.thisDevice,a=(BirdAlbumProject.textureLoader,BirdAlbumProject.planePositions),o=100,r=30,s=20,d=$("#canvas"),c=5,l=new Stats;l.setMode(0),l.domElement.style.position="fixed",l.domElement.style.right="5px",l.domElement.style.top="5px",l.domElement.style.zIndex=100,document.body.appendChild(l.domElement);var m=window.innerWidth,u=window.innerHeight,p=new THREE.WebGLRenderer;p.setSize(m,u),p.setClearColor("#ffffff",1),d.append(p.domElement);var h=new THREE.PerspectiveCamera(45,m/u,1,4e3);"PC"===n?(h.position.set(300,300,300),h.lookAt(new THREE.Vector3(0,0,0))):"SM"===n&&(h.position.set(0,0,0),h.lookAt(new THREE.Vector3(1,0,0)));var f=new THREE.Scene;if("PC"===n){var v=new THREE.OrbitControls(h);v.enableZoom=!1}else if("SM"===n)var v=new THREE.DeviceOrientationControls(h);var g=new THREE.DirectionalLight(16777215,1);g.position.set(0,100,0),f.add(g);var b=new THREE.AmbientLight(10855845,1);f.add(b),$(window).on("resize",function(){h.aspect=window.innerWidth/window.innerHeight,h.updateProjectionMatrix(),p.setSize(window.innerWidth,window.innerHeight)});var j=function(){var t=[],i=BirdAlbumProject.emptyImg,n=new THREE.Texture(i);for(n.needsUpdate=!0,e=0;o>e;e++){var a=new THREE.PlaneGeometry(r,s),d=new THREE.MeshPhongMaterial({map:n,side:THREE.DoubleSide,opacity:0,transparent:!0,depthWrite:!1});t[e]=new THREE.Mesh(a,d),t[e].name=e,f.add(t[e])}return t}(),w=function(){var t=[],i=new THREE.BoxGeometry(0,0,0),n=new THREE.MeshPhongMaterial({color:16711680});for(e=0;c>e;e++){var a=new THREE.Mesh(i,n);a.position.set(0,0,0),a.name=e,f.add(a),t.push(a)}return t}();if(function(){for(e=0;o>e;e++){var t=a[e].posX,i=a[e].posY,n=a[e].posZ,r=a[e].rotX,s=a[e].rotY,d=a[e].rotZ;j[e].position.set(t,i,n),j[e].rotation.set(r,s,d)}for(e=0;o>e;e++){var c=Math.floor(e/20);w[c].add(j[e])}}(),"SM"===n){var B=BirdAlbumProject.season;$(document).ready(function(){$(this).gShake(function(){t.emit("shake",{id:i,season:B})})})}var P=new rayCastClosure(h,d,m,u,j),y=new OmniSphere(f);y.createOmniSphere(),y.changeMode("spring");var E=new animationClosure(j,w);main(j,y,E,P),function S(){requestAnimationFrame(S),E.observe(),v.update(),l.update(),p.render(f,h)}()}function main(e,t,i,n){function a(e){for(var t=d.length,i=0;t>i;i++){var n=e[i],a=document.createElement("canvas"),o=a.getContext("2d"),r=BirdAlbumProject.spriteJSON[n],s=r.x,c=r.y,l=256;a.width=a.height=l,o.drawImage(BirdAlbumProject.spriteImage,s,c,l,l,0,0,l,l);var m=new THREE.Texture(a);m.needsUpdate=!0,d[i].birdName=n,d[i].material.map=m}}var o=BirdAlbumProject.thisDevice,r=BirdAlbumProject.socket,s=BirdAlbumProject.this_roomID,d=e,c=i,l=t,m=n;if("PC"===o)var u=$(".birdNavWindow"),p=$(".birdNavWindow__birdName"),h=$(".birdNavWindow__type"),f=$(".birdNavWindow__birdPicture"),v=$(".birdNavWindow__soundIcon");if("PC"===o)var g=new SoundJukeBox;$("#start").on("click",function(){r.emit("startDisplay",{id:s}),"SM"===o&&$("#navWrap").addClass("js-disappear")}),"PC"===BirdAlbumProject.thisDevice?($(".header__menuIconWrapper").on({mouseenter:function(){$(".header__pullDownMenu").addClass("js-show")},mouseleave:function(){$(".header__pullDownMenu").removeClass("js-show")}}),function(){var e=!0;$(".soundIconWrapper").on("click",function(){e?(e=!1,$(this).addClass("js-soundOff"),$(this).siblings("p").text("sound off"),g.BGM_state="stop",g.isAvailable&&g.stopBGM()):(e=!0,$(this).removeClass("js-soundOff"),$(this).siblings("p").text("sound on"),g.BGM_state="playing",g.isAvailable&&g.startBGM())})}(),$(".seasonBtn").on("click",function(e){BirdAlbumProject.season=e.target.value,r.emit("changeSeason",{id:s,season:e.target.value})}),$(".birdNavWindow__deleteIcon").on("click",function(){u.addClass("js-slideOutToLeft")})):"SM"===BirdAlbumProject.thisDevice&&$("#check").on("click",function(){BirdAlbumProject.socket.emit("startDisplay",{id:s})}),"PC"===o&&($(".birdNavWindow__soundIcon").load("img/svg/soundOnIcon.svg svg"),$(".birdNavWindow__deleteIcon").load("img/svg/deleteIcon.svg svg")),r.on("SM_login",function(){$("#firstIntroWindow").addClass("js-disappear"),$("#headerWrapper").css("transform","translateY(0)"),$(".main__mainGearIconWrapper").addClass("js-slideInFromOutside"),$(".main__mainGearIcon").addClass("js-rotate")}),r.on("startDisplay",function(e){var t=e.birdNames;a(t),c.changeAnimationMode("appear"),m.changeRayCastSwitch(!0),"PC"===o&&(g.isAvailable=!0,g.setBirdNames(t),"playing"===g.BGM_state&&g.startBGM())}),r.on("selectBird",function(e){if("PC"===o){var t=e.birdName,i=BirdAlbumProject.birdData[t].JPName,n=BirdAlbumProject.birdData[t].type,a=document.createElement("canvas"),r=a.getContext("2d"),s=BirdAlbumProject.spriteJSON[t],d=s.x,c=s.y;a.width=450,a.height=300,r.drawImage(BirdAlbumProject.spriteImage,d,c,256,256,0,0,450,300);var l=a;f.html(""),v.off("click"),p.text(i),h.text(n),f.append(l),function(){var e,i=!1;v.on({click:function(){if(i)clearTimeout(e),i=!1,v.removeClass("js-turnPink"),g.stopSpecificBirdSound();else{var n=g.playSpecificBirdSound(t);n?(i=!0,v.addClass("js-turnPink"),e=setTimeout(function(){i=!1,v.removeClass("js-turnPink")},7500)):console.log("no")}},mouseenter:function(){v.addClass("js-enlarge")},mouseleave:function(){v.removeClass("js-enlarge")}})}(),u.removeClass("js-slideInFromLeft js-slideOutToLeft"),u.addClass("js-slideInFromLeft")}}),r.on("changeSeason",function(e){var t=e.season,i=e.birdNames;"PC"===o&&(g.stopBGM(),g.setBirdNames(i)),l.fadeOut(),c.changeAnimationMode("disappear"),setTimeout(function(){if(a(i),l.changeMode(t),l.fadeIn(),c.changeAnimationMode("appear"),"PC"===o){switch(t){case"spring":$(".main__seasonTeller").text("春");break;case"summer":$(".main__seasonTeller").text("夏");break;case"fall":$(".main__seasonTeller").text("秋");break;case"winter":$(".main__seasonTeller").text("冬")}g.startBGM()}},1e3)}),r.on("tapStart",function(e){var t=e.parentObjectName;c.changeRotateSwitch(t,!1)}),r.on("tapMove",function(e){var t=e.parentObjectName,i=e.speed;c.rotateSpecificParent(t,i)}),r.on("tapEnd",function(e){function t(){c.rotateSpecificParent(i,a.speed)}var i=e.parentObjectName,n=e.speed;if(c.changeRotateSwitch(i,!0),0!==n){var a={speed:n};TweenLite.to(a,1,{speed:0,onUpdate:t})}}),r.on("shake",function(e){var t=e.birdNames;c.changeAnimationMode("shaffle"),a(t)})}var BirdAlbumProject=BirdAlbumProject||{};BirdAlbumProject={socket:io.connect(),this_roomID:$("#roomID").val(),thisDevice:$("#thisDevice").val(),planePositions:"",birdData:"",spriteImage:"",spriteJSON:"",envSpriteImg:[],envSpriteJSON:[],emptyImg:[],season:"spring",loader:""},function(){var e=BirdAlbumProject.socket,t=BirdAlbumProject.thisDevice,i=BirdAlbumProject.this_roomID;"PC"===t?e.emit("PC_login",{id:i}):"SM"===t&&e.emit("SM_login",{id:i})}(),function(){var e=BirdAlbumProject.thisDevice,t=BirdAlbumProject.this_roomID,e=BirdAlbumProject.thisDevice;console.log(t),"PC"===e&&$("#QRCode").qrcode("birdalbum356.herokuapp.com/smartphone?id="+t)}(),SoundJukeBox.prototype={playSpecificBirdSound:function(e){var t=this;return this.specificBirdSoundChannel=createjs.Sound.createInstance(e),this.specificBirdSoundChannel.play(),"playSucceeded"!==this.specificBirdSoundChannel.playState?!1:("playing"===this.BGM_state&&this.BGMchannel._pause(),setTimeout(function(){"playing"===t.BGM_state&&t.BGMchannel._resume()},7500),!0)},stopSpecificBirdSound:function(){"playing"===this.BGM_state&&this.BGMchannel._resume(),this.specificBirdSoundChannel.stop()},setBirdNames:function(e){this.birdNameList=e},startBGM:function(){if("stop"!==this.BGM_state){var e=this;return this.BGMchannel=this.createRandomInstance(),this.BGMchannel.play(),"playSucceeded"!==this.BGMchannel.playState?this.startBGM():void this.BGMchannel.on("complete",function(){e.startBGM()})}},stopBGM:function(){"playing"!==this.BGM_state&&this.BGMchannel.stop()},createRandomInstance:function(){var e=this.birdNameList.length,t=Math.floor(Math.random()*e),i=this.birdNameList[t],n=createjs.Sound.createInstance(i);return n}},OmniSphere.prototype={createOmniSphere:function(){var e=this,t=new THREE.SphereGeometry(1e3,32,32),i=new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide}),n=new THREE.Mesh(t,i);e.scene.add(n),this.geometry=n},changeMode:function(e){var t=new THREE.Texture(this.loader.getResult(e+"Img"));t.needsUpdate=!0,this.geometry.material.map=t},fadeOut:function(){TweenLite.fromTo(this.geometry.material,1,{opacity:1},{opacity:0})},fadeIn:function(){TweenLite.fromTo(this.geometry.material,1,{opacity:0},{opacity:1})}},$(window).on("touchmove.noScroll",function(e){e.preventDefault()}),preloadData();